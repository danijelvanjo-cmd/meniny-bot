import telebot
import flask
import os
from datetime import datetime

TOKEN = os.environ["TOKEN"]

bot = telebot.TeleBot(TOKEN, threaded=False)
app = flask.Flask(__name__)


# Full namedays dict (from your Vojvodina calendar)
namedays = {
    "01-01": "Nov√Ω rok, Je≈æi≈°",
    "01-02": "√Åbel, Set",
    "01-03": "Daniel",
    "01-04": "Eugen",
    "01-05": "Sime√≥n, Andrea",
    "01-06": "Zj. Kr. P√°na, Ga≈°par, Melich√°r, Baltaz√°r",
    "01-07": "Bohuslava",
    "01-08": "Pravdomil",
    "01-09": "Pravoƒæub, Alexej",
    "01-10": "Dalim√≠r",
    "01-11": "Malv√≠na, Majda",
    "01-12": "Rastislav",
    "01-13": "ƒåistko",
    "01-14": "≈†≈•astko",
    "01-15": "Dobroslav",
    "01-16": "Vladim√≠r",
    "01-17": "Anton, Nata≈°a",
    "01-18": "Bohdana, Teodora",
    "01-19": "S√°ra, Drahom√≠ra",
    "01-20": "Dalibor",
    "01-21": "Vincent",
    "01-22": "Zora, Alexandra",
    "01-23": "Milo≈°",
    "01-24": "Ctiboh, Timotej",
    "01-25": "Pavel",
    "01-26": "Sv√§toboj, Tamara",
    "01-27": "J√°n Zlato√∫sty",
    "01-28": "Karol",
    "01-29": "Pribina",
    "01-30": "Ema, Amadea",
    "01-31": "Emil",
    "02-01": "Tatiana, Tea",
    "02-02": "M√°ria - Hromnice",
    "02-03": "Bla≈æej",
    "02-04": "Veronika, Veronka",
    "02-05": "Svetlu≈°a, Aƒæo≈°a",
    "02-06": "Dorota",
    "02-07": "D√°ria, Dajana",
    "02-08": "Prokop",
    "02-09": "Zdenko",
    "02-10": "Gorazd",
    "02-11": "Libu≈°a",
    "02-12": "Zoroslav",
    "02-13": "Horislav",
    "02-14": "Velim√≠r, Valent√≠n",
    "02-15": "De≈à ≈°t√°tnosti",
    "02-16": "Juliana",
    "02-17": "Miloslava",
    "02-18": "Jarom√≠r",
    "02-19": "Zuzana",
    "02-20": "V≈°emil, L√≠via",
    "02-21": "Eleon√≥ra, Lena, Lenka",
    "02-22": "Veleslava",
    "02-23": "Laz√°r, Leon√≥ra",
    "02-24": "Matej",
    "02-25": "Viktor",
    "02-26": "Alexander, Sa≈°a",
    "02-27": "Drahot√≠na, Drahu≈°a",
    "02-28": "Zlatica, Zlatka",
    "02-29": "Roman",
    "03-01": "Alb√≠n, Belo",
    "03-02": "Am√°lia, Mia",
    "03-03": "Bohumil",
    "03-04": "Jadran, Adrian",
    "03-05": "Fridrich",
    "03-06": "Radoslav",
    "03-07": "Tom√°≈°",
    "03-08": "Medzin√°rodn√Ω de≈à ≈æien",
    "03-09": "Rad√∫z",
    "03-10": "Branislav",
    "03-11": "Jurina, Dina",
    "03-12": "Gregor",
    "03-13": "Vlastimil",
    "03-14": "Matilda, Maja",
    "03-15": "Belom√≠r, Svetlana",
    "03-16": "Boleslav",
    "03-17": "ƒΩubica",
    "03-18": "Ctislav, Hviezdoslav",
    "03-19": "Jozef",
    "03-20": "V√≠≈•azoslav",
    "03-21": "Blahoslav",
    "03-22": "Vesna, Kazim√≠r",
    "03-23": "Darko, D√°rius",
    "03-24": "Gabriel",
    "03-25": "Zves≈• narodenia Krista P√°na",
    "03-26": "Emanuel, Emanuela",
    "03-27": "Alena, Aneta",
    "03-28": "So≈àa, Rastislava",
    "03-29": "Miroslav, Sab√≠na",
    "03-30": "Vieroslava",
    "03-31": "Gabriela",
    "04-01": "Hugo",
    "04-02": "≈†≈•astka",
    "04-03": "Bohur√°d, Richard",
    "04-04": "Bohumila, Izidora",
    "04-05": "Bohuslav",
    "04-06": "Irena",
    "04-07": "Radho≈°≈•",
    "04-08": "Dagmar, Albert",
    "04-09": "Milena, Mil√©va",
    "04-10": "Igor",
    "04-11": "J√∫lius, Leona",
    "04-12": "Estera",
    "04-13": "Silor√°d",
    "04-14": "Hrdo≈°",
    "04-15": "Fedor",
    "04-16": "Danica, Dana",
    "04-17": "Rudolf",
    "04-18": "Val√©r",
    "04-19": "Ratim√≠r",
    "04-20": "Hvezdo≈à, Marcel",
    "04-21": "≈Ωelislav",
    "04-22": "Vojtech, Sv√§tom√≠r",
    "04-23": "Jelena, Jela",
    "04-24": "Juraj, ƒéuro",
    "04-25": "Marek, Marko",
    "04-26": "Jaroslava",
    "04-27": "Jaroslav",
    "04-28": "Jarmila",
    "04-29": "Dobr√¥tka, Lea, Leo",
    "04-30": "Miroslava",
    "05-01": "Sviatok pr√°ce, Filip",
    "05-02": "≈Ωigmund",
    "05-03": "Desana, Denis",
    "05-04": "Flori√°n, Alex",
    "05-05": "Kvetoslav",
    "05-06": "Herm√≠na, Mina",
    "05-07": "Stanislav, Monika",
    "05-08": "Milut√≠n, Ingrid, Ines",
    "05-09": "De≈à v√≠≈•azstva",
    "05-10": "Vikt√≥ria",
    "05-11": "Bla≈æena",
    "05-12": "Pankr√°c",
    "05-13": "Serv√°c",
    "05-14": "Bonif√°c",
    "05-15": "≈Ωofia, Sofia",
    "05-16": "Svetoz√°r",
    "05-17": "Zobor",
    "05-18": "Viola, Vida",
    "05-19": "Dezider, Hana",
    "05-20": "Borivoj",
    "05-21": "Dobrom√≠r",
    "05-22": "J√∫lia, Petra",
    "05-23": "≈Ωelm√≠ra",
    "05-24": "Danu≈°a, Daniela",
    "05-25": "Urban",
    "05-26": "Du≈°an",
    "05-27": "Miliduch, Iveta",
    "05-28": "Viliam",
    "05-29": "Vilma, Amanda",
    "05-30": "Ferdinand",
    "05-31": "Blahoslava, Ivona",
    "06-01": "Ale≈°, ≈Ωaneta",
    "06-02": "Vlastimila, X√©nia",
    "06-03": "Bronislav",
    "06-04": "Divi≈°, Pravoslava",
    "06-05": "Meƒçislav, Laura",
    "06-06": "Radoboj",
    "06-07": "Borislav, R√≥bert",
    "06-08": "Medard",
    "06-09": "Vojislav, Stanislava",
    "06-10": "ƒåestimir, Margar√©ta",
    "06-11": "Barnab√°≈°",
    "06-12": "Sv√§toslav",
    "06-13": "Milada, Kasandra",
    "06-14": "Vasil",
    "06-15": "V√≠t, Sandra",
    "06-16": "Bo≈æetech",
    "06-17": "Vladivoj",
    "06-18": "Vratislav",
    "06-19": "Voƒænomil",
    "06-20": "Val√©ria, Klaudia",
    "06-21": "Alojz, Blanka",
    "06-22": "Paul√≠na, Maru≈°a",
    "06-23": "Zeno, Zena",
    "06-24": "J√°n Krstiteƒæ",
    "06-25": "Olivera, Oliver",
    "06-26": "Jeremi√°≈°, Adri√°na",
    "06-27": "Ladislav, Nat√°lia",
    "06-28": "Slavoj, Be√°ta",
    "06-29": "Peter a Pavel",
    "06-30": "Vlastim√≠r, Mel√°nia, Melita",
    "07-01": "ƒΩubor, Liliana",
    "07-02": "Berta, Debora",
    "07-03": "Miloslav",
    "07-04": "Ervin, Mateja",
    "07-05": "Cyril a Metod",
    "07-06": "Majster J√°n Hus",
    "07-07": "Veleslav",
    "07-08": "Ivan, Johana",
    "07-09": "Lujza, Iva",
    "07-10": "Liba, Lada",
    "07-11": "Milota, Milu≈°a",
    "07-12": "Bori≈°a, Nina",
    "07-13": "Margita, Nik√©",
    "07-14": "Kamil, Le√≥n",
    "07-15": "Karol√≠na, Henrich",
    "07-16": "R√∫t, Hviezdoslava",
    "07-17": "Svor√°d",
    "07-18": "Kamila, Kalina",
    "07-19": "Du≈°ana",
    "07-20": "Eli√°≈°",
    "07-21": "Ant√≥nia, Tina",
    "07-22": "Magdal√©na",
    "07-23": "Oƒæga, Olina",
    "07-24": "Krist√≠na",
    "07-25": "Jakub",
    "07-26": "Anna",
    "07-27": "Marta",
    "07-28": "Sv√§to≈°, Kri≈°tof",
    "07-29": "Bo≈æena",
    "07-30": "Juli√°n, Nino",
    "07-31": "Ernest√≠na, Erik, Erika",
    "08-01": "ƒΩubomil, ƒΩuboslav",
    "08-02": "Adolf, Gust√°v",
    "08-03": "August, August√≠n",
    "08-04": "Krasoslav, Dominik",
    "08-05": "Jadviga, Hedviga",
    "08-06": "Jozef√≠na, Jozefa",
    "08-07": "≈†tef√°nia, ≈†tefana",
    "08-08": "Osk√°r",
    "08-09": "Ratibor",
    "08-10": "Vavrinec",
    "08-11": "Jasna, ƒΩubom√≠ra",
    "08-12": "Darina, Da≈°a",
    "08-13": "ƒΩubom√≠r",
    "08-14": "Mojm√≠r, Marcela",
    "08-15": "Veƒæk√° M√°ria",
    "08-16": "T√≠tus, Timea",
    "08-17": "Michaela, Milica",
    "08-18": "Helena, Elena",
    "08-19": "Vratislava",
    "08-20": "L√Ωdia, Anabela",
    "08-21": "Jana, Ivana",
    "08-22": "Franti≈°ka",
    "08-23": "Vlastislav",
    "08-24": "Bartolomej",
    "08-25": "ƒΩudov√≠t",
    "08-26": "Samuel",
    "08-27": "Ru≈æena, Silvia",
    "08-28": "Augusta, August√≠na",
    "08-29": "S≈•atie J√°na",
    "08-30": "Benjam√≠n",
    "08-31": "Tichom√≠r, Nora",
    "09-01": "Drahoslava",
    "09-02": "Bronislava",
    "09-03": "Otokar",
    "09-04": "Roz√°lia, R√°chel",
    "09-05": "Budislava",
    "09-06": "Boemil, Alica",
    "09-07": "Mariena, Mariana",
    "09-08": "Annam√°ria, M√°≈°a",
    "09-09": "Martina, Dobru≈°a",
    "09-10": "Oleg, Patrik",
    "09-11": "Zdislav",
    "09-12": "Dobroslava",
    "09-13": "Ctibor",
    "09-14": "Drahot√≠n",
    "09-15": "Duchoslav, Jolana",
    "09-16": "ƒΩudmila",
    "09-17": "Drahoslav",
    "09-18": "Radom√≠r",
    "09-19": "Kon≈°tant√≠n",
    "09-20": "ƒΩuboslava",
    "09-21": "Mat√∫≈°",
    "09-22": "M√≥ric",
    "09-23": "Zdenka",
    "09-24": "ƒΩubo≈°",
    "09-25": "Vladislav",
    "09-26": "Edita, Vladislava",
    "09-27": "Damian, Kozmas",
    "09-28": "V√°clav",
    "09-29": "Michal",
    "09-30": "Jarol√≠m",
    "10-01": "Arnold, Bel√≠na",
    "10-02": "Levoslav",
    "10-03": "Koloman",
    "10-04": "Franti≈°ek, Fero",
    "10-05": "Blahom√≠r",
    "10-06": "Viera, Patr√≠cia",
    "10-07": "Eli≈°ka, Ela",
    "10-08": "Eug√©nia, Una",
    "10-09": "Silas, Anast√°zia",
    "10-10": "Gede√≥n, Slavom√≠ra",
    "10-11": "Zvonim√≠r, Zvonim√≠ra",
    "10-12": "Maximili√°n, Maxim",
    "10-13": "Eduard, Edv√≠n",
    "10-14": "Boris",
    "10-15": "Ter√©zia",
    "10-16": "G√°l, Vladim√≠ra",
    "10-17": "Bo≈æej, Ign√°c",
    "10-18": "Luk√°≈°",
    "10-19": "Kristi√°n",
    "10-20": "Vendel√≠n",
    "10-21": "Ur≈°uƒæa",
    "10-22": "Dobromil, Sergej",
    "10-23": "≈Ωitom√≠r",
    "10-24": "Kvetoslava",
    "10-25": "Zlatko, Zlatu≈°a",
    "10-26": "Mitar, Demeter",
    "10-27": "Horislava, Stela",
    "10-28": "≈†imon, J√∫da",
    "10-29": "Kl√°ra, Valent√≠na",
    "10-30": "Petronela, Simona",
    "10-31": "Aurelia",
    "11-01": "V≈°echsv√§t√Ωch, Diana",
    "11-02": "Vekoslav, Denisa",
    "11-03": "Ida, Elizabeta",
    "11-04": "Hostimil",
    "11-05": "Imrich",
    "11-06": "Ren√°ta",
    "11-07": "Bohoƒæub",
    "11-08": "Bohum√≠r",
    "11-09": "Fedora",
    "11-10": "Mari√°n, Tibor",
    "11-11": "De≈à pr√≠meria, Martin",
    "11-12": "Sv√§topluk",
    "11-13": "ƒΩutobor",
    "11-14": "Mladen",
    "11-15": "Irma, Klement√≠na",
    "11-16": "Ane≈æka, Agneza",
    "11-17": "Dion√Ωz, Sebasti√°n",
    "11-18": "Oto",
    "11-19": "Al≈æbeta, Er≈æa",
    "11-20": "Bohum√≠ra",
    "11-21": "Ctirad",
    "11-22": "Ernest, Naƒèa",
    "11-23": "Dagmara",
    "11-24": "Em√≠lia, Milina",
    "11-25": "Katar√≠na",
    "11-26": "Kornel",
    "11-27": "Nestor, Noe",
    "11-28": "Milan, Henrieta",
    "11-29": "Vratko",
    "11-30": "Ondrej, Andrej",
    "12-01": "Sl√°via",
    "12-02": "Budislav",
    "12-03": "Slavom√≠r",
    "12-04": "Barbara, Barbora",
    "12-05": "S√°va",
    "12-06": "Mikul√°≈°",
    "12-07": "Ambr√≥z",
    "12-08": "M√°rio, Mar√≠na",
    "12-09": "Izabela",
    "12-10": "Judita",
    "12-11": "Hostiv√≠t",
    "12-12": "Ot√≠lia",
    "12-13": "Lucia",
    "12-14": "Branislava",
    "12-15": "Ivor, Ivica",
    "12-16": "Alb√≠na, Bela",
    "12-17": "Korn√©lia, Korina",
    "12-18": "Osvet√≠n, Sl√°via",
    "12-19": "Abrah√°m",
    "12-20": "Iz√°k",
    "12-21": "Tom√°≈°, Bohdan",
    "12-22": "Adela, Etela",
    "12-23": "Nade≈æda, Vlasta",
    "12-24": "≈†tedr√Ω de≈à, Adam a Eva",
    "12-25": "Narodenie Krista P√°na",
    "12-26": "≈†tefan muƒçen√≠k",
    "12-27": "J√°n evanjelista",
    "12-28": "Ml√°ƒèatk√°, Silvia",
    "12-29": "Jonat√°n",
    "12-30": "D√°vid",
    "12-31": "Silvester",
}


name_to_date = {}
for date, names in namedays.items():
    cleaned = names.replace(" a ", ", ").replace(" - ", ", ")
    for name in [n.strip() for n in cleaned.split(",") if n.strip()]:
        name_to_date[name.lower()] = date

@bot.message_handler(commands=["start", "help"])
def send_help(message):
    bot.send_message(
        message.chat.id,
        "Zvl√°≈°tny meninov√Ω bot üòä\n\n"
        "/meniny ‚Üí dne≈°n√© meniny\n"
        "/meniny dnes ‚Üí to ist√©\n"
        "/meniny 17.12 ‚Üí meniny v dan√Ω d√°tum\n"
        "/meniny Daniel ‚Üí d√°tum men√≠n pre dan√© meno\n\n"
        "!meniny ‚Üí dne≈°n√© meniny (v skupin√°ch)"
    )

@bot.message_handler(commands=["meniny"])
def handle_meniny(message):
    args = message.text.split(maxsplit=1)
    query = args[1].strip() if len(args) > 1 else ""

    if not query or query.lower() in ["dnes", "dnes", "dneska"]:
        key = datetime.now().strftime("%m-%d")
        names = namedays.get(key, "Dnes nem√° meniny nikto.")
        date = datetime.now().strftime("%d.%m.%Y")
        bot.send_message(message.chat.id, f"Dnes ({date}): {names}")

    elif any(sep in query for sep in [".", "-", "/"]):
        try:
            cleaned = query.replace("/", ".").replace("-", ".")
            day, month = cleaned.split(".")[:2]
            key = f"{month.zfill(2)}-{day.zfill(2)}"
            bot.send_message(message.chat.id, f"{query}: {namedays.get(key, 'V tento d√°tum nem√° meniny nikto.')}")
        except:
            bot.send_message(message.chat.id, "Nespr√°vny form√°t d√°tumu ‚Äì pou≈æite dd.mm üòÖ")

    else:
        date = name_to_date.get(query.lower())
        if date:
            d, m = date.split("-")
            bot.send_message(message.chat.id, f"{query.capitalize()} m√° meniny d≈àa {d}.{m}.")
        else:
            bot.send_message(message.chat.id, "Meno nebolo n√°jden√©. üòî")

@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("!meniny"))
def handle_group(message):
    key = datetime.now().strftime("%m-%d")
    names = namedays.get(key, "Dnes nem√° meniny nikto.")
    date = datetime.now().strftime("%d.%m.%Y")
    bot.send_message(message.chat.id, f"Dnes ({date}): {names}")

@app.route("/" + TOKEN, methods=["POST"])
def telegram_webhook():
    update = telebot.types.Update.de_json(
        flask.request.get_data().decode("utf-8")
    )
    bot.process_new_updates([update])
    return "OK", 200


@app.route("/")
def index():
    return "Bot is alive and looking at % of alcohol in Padinec's blood"

if os.environ.get("RENDER"):
    bot.remove_webhook()
    bot.set_webhook(
        url=f"https://meniny-bot.onrender.com/{TOKEN}"
    )

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
